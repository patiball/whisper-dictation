sequenceDiagram
    autonumber
    
    participant User as ğŸ‘¤ UÅ¼ytkownik
    participant App as ğŸ“± StatusBarApp
    participant Rec as ğŸ™ï¸ Recorder
    participant PyA as ğŸ”Š PyAudio
    participant Trans as ğŸ¤– Transcriber
    participant DM as âš™ï¸ DeviceManager
    participant Whisper as ğŸ§  Whisper Model
    participant EH as âš ï¸ Error Handler
    
    rect rgb(255, 220, 220)
        Note over User,EH: SCENARIUSZ 1: BÅ‚Ä…d inicjalizacji - Model nie moÅ¼e byÄ‡ zaÅ‚adowany na MPS
        
        App->>DM: get_device_for_operation(MODEL_LOADING)
        activate DM
        DM-->>App: "mps"
        deactivate DM
        
        App->>Whisper: load_model("base", device="mps")
        activate Whisper
        Whisper-->>App: âŒ Exception (OOM / MPS error)
        deactivate Whisper
        
        App->>DM: should_retry_with_fallback(exception)
        activate DM
        DM-->>App: True (powinien sprÃ³bowaÄ‡ fallback)
        deactivate DM
        
        App->>DM: handle_device_error_enhanced(e, MODEL_LOADING, "mps")
        activate DM
        DM->>DM: Wybiera fallback device = "cpu"
        DM-->>App: ("cpu", "ğŸ”„ Wykryto problem z MPS. PrzeÅ‚Ä…czam na CPU...")
        deactivate DM
        
        App->>EH: Print user_message
        activate EH
        EH-->>User: ğŸ”„ Komunikat: "PrzeÅ‚Ä…czam na CPU dla stabilnoÅ›ci"
        deactivate EH
        
        App->>Whisper: load_model("base", device="cpu")
        activate Whisper
        Note right of Whisper: Retry na CPU
        Whisper-->>App: âœ… model loaded
        deactivate Whisper
        
        App->>DM: optimize_model(model, "cpu")
        App->>DM: register_operation_success("cpu", MODEL_LOADING)
        
        Note over App: âœ… Aplikacja dziaÅ‚a na CPU
    end
    
    rect rgb(255, 240, 200)
        Note over User,EH: SCENARIUSZ 2: BÅ‚Ä…d nagrywania - Brak mikrofonu
        
        User->>App: NaciÅ›niÄ™cie skrÃ³tu (Cmd+Option)
        App->>Rec: start(language="pl")
        activate Rec
        
        Rec->>PyA: open stream (16kHz, mono, paInt16)
        activate PyA
        PyA-->>Rec: âŒ Exception: "No input device available"
        deactivate PyA
        
        Rec->>EH: Catch Exception
        activate EH
        EH->>EH: print(f"Failed to start recording: {e}")
        EH-->>User: âš ï¸ BÅ‚Ä…d: "Nie moÅ¼na rozpoczÄ…Ä‡ nagrywania"
        deactivate EH
        
        Rec->>App: recording = False (nie udaÅ‚o siÄ™)
        deactivate Rec
        
        App->>App: title = "â¯" (powrÃ³t do idle)
        Note right of App: UÅ¼ytkownik moÅ¼e:<br/>1. PodÅ‚Ä…czyÄ‡ mikrofon<br/>2. SprawdziÄ‡ uprawnienia<br/>3. SprÃ³bowaÄ‡ ponownie
    end
    
    rect rgb(240, 220, 255)
        Note over User,EH: SCENARIUSZ 3: Stream overflow (bufor przepeÅ‚niony)
        
        User->>App: Start nagrywania
        App->>Rec: start()
        activate Rec
        Rec->>PyA: open stream + read loop
        activate PyA
        
        loop Nagrywanie
            PyA->>Rec: read(1024, exception_on_overflow=False)
            Note right of PyA: Overflow ignorowany<br/>(exception_on_overflow=False)
        end
        
        PyA->>Rec: âš ï¸ Warning: Input overflow (data)
        Note right of Rec: Zwraca dane mimo overflow<br/>Aplikacja kontynuuje
        
        Rec->>Rec: frames.append(data)
        Note right of Rec: Dane mogÄ… zawieraÄ‡<br/>artefakty, ale nagranie<br/>dziaÅ‚a dalej
        
        deactivate PyA
        deactivate Rec
        Note over Rec: âœ“ Nagranie kontynuowane<br/>(graceful degradation)
    end
    
    rect rgb(220, 240, 255)
        Note over User,EH: SCENARIUSZ 4: BÅ‚Ä…d transkrypcji (OOM podczas inference)
        
        Rec->>Trans: transcribe(audio_data_fp32, language="pl")
        activate Trans
        
        Trans->>DM: get_device_for_operation(TRANSCRIPTION)
        activate DM
        DM-->>Trans: "mps"
        deactivate DM
        
        Trans->>Whisper: model.transcribe(audio_data, **options)
        activate Whisper
        Note right of Whisper: PrÃ³ba transkrypcji<br/>dÅ‚ugiego audio na MPS
        Whisper-->>Trans: âŒ RuntimeError: Out of memory (MPS)
        deactivate Whisper
        
        Trans->>DM: should_retry_with_fallback(e)
        activate DM
        DM-->>Trans: True
        deactivate DM
        
        Trans->>DM: handle_device_error_enhanced(e, TRANSCRIPTION, "mps")
        activate DM
        DM->>DM: Fallback decision: "mps" â†’ "cpu"
        DM-->>Trans: ("cpu", "ğŸ”„ Wykryto problem z transkrypcjÄ…. Ponawiam na CPU...")
        deactivate DM
        
        Trans->>EH: Print user_message
        activate EH
        EH-->>User: ğŸ”„ "Ponawiam transkrypcjÄ™ na CPU"
        deactivate EH
        
        Trans->>Whisper: model.to("cpu")
        activate Whisper
        Note right of Whisper: Przeniesienie modelu<br/>do pamiÄ™ci CPU
        Whisper-->>Trans: model moved
        deactivate Whisper
        
        Trans->>DM: optimize_model(model, "cpu")
        Trans->>DM: get_optimized_settings("cpu", model_size)
        activate DM
        DM-->>Trans: fallback_options {fp16: False, ...}
        deactivate DM
        
        Trans->>Whisper: model.transcribe(audio_data, **fallback_options)
        activate Whisper
        Note right of Whisper: Retry na CPU<br/>(bez FP16)
        Whisper-->>Trans: âœ… result {"text": "...", "language": "pl"}
        deactivate Whisper
        
        Trans->>DM: register_operation_success("cpu", TRANSCRIPTION)
        
        Trans->>User: Wpisywanie tekstu (keyboard output)
        deactivate Trans
        
        Note over Trans: âœ… Transkrypcja zakoÅ„czona<br/>pomyÅ›lnie na CPU
    end
    
    rect rgb(250, 230, 230)
        Note over User,EH: SCENARIUSZ 5: JÄ™zyk poza allowed_languages
        
        User->>App: Start nagrywania (mÃ³wi po niemiecku)
        Note right of User: allowed_languages = ["en", "pl"]
        
        Rec->>Trans: transcribe(audio_data, language=None)
        activate Trans
        
        Trans->>Whisper: model.transcribe(audio_data, language=None)
        activate Whisper
        Note right of Whisper: Auto-detect jÄ™zyka
        Whisper-->>Trans: result {"text": "Guten Tag", "language": "de"}
        deactivate Whisper
        
        Trans->>Trans: detected_lang = "de"
        Trans->>Trans: Check: "de" in ["en", "pl"]?
        Note right of Trans: âŒ JÄ™zyk nie dozwolony
        
        Trans->>Trans: Override: language = allowed_languages[0] = "en"
        Note right of Trans: Wymuszenie jÄ™zyka<br/>z listy dozwolonych
        
        Trans->>Whisper: model.transcribe(audio_data, language="en")
        activate Whisper
        Note right of Whisper: Re-transcribe<br/>z wymuszonym jÄ™zykiem
        Whisper-->>Trans: result {"text": "Good day", "language": "en"}
        deactivate Whisper
        
        Trans->>User: Wpisywanie tekstu (moÅ¼e byÄ‡ niedokÅ‚adny)
        deactivate Trans
        
        Note over Trans: âš ï¸ Transkrypcja z wymuszonym jÄ™zykiem<br/>(moÅ¼e byÄ‡ mniej dokÅ‚adna)
    end
    
    rect rgb(255, 245, 230)
        Note over User,EH: SCENARIUSZ 6: BÅ‚Ä…d wpisywania tekstu (brak uprawnieÅ„ accessibility)
        
        Trans->>Trans: Iteracja przez result["text"]
        activate Trans
        
        loop KaÅ¼dy znak
            Trans->>EH: try: pykeyboard.type(char)
            activate EH
            EH-->>Trans: âŒ Exception: "Accessibility permissions denied"
            deactivate EH
            
            Trans->>Trans: except: pass (cicho ignoruj)
            Note right of Trans: Znak pominiÄ™ty<br/>bez komunikatu bÅ‚Ä™du
            
            Trans->>Trans: time.sleep(0.0025)
        end
        
        deactivate Trans
        
        Note over User: âš ï¸ Tekst nie zostaÅ‚ wklejony<br/>UÅ¼ytkownik musi:<br/>1. NadaÄ‡ uprawnienia Accessibility<br/>2. ZrestartowaÄ‡ aplikacjÄ™<br/>3. SprÃ³bowaÄ‡ ponownie
        
        Note over EH: Design decision:<br/>Silent failure dla wpisywania<br/>(lepsze UX niÅ¼ crash)
    end
    
    Note over User,EH: Wszystkie scenariusze bÅ‚Ä™dÃ³w obsÅ‚uÅ¼one z graceful degradation
